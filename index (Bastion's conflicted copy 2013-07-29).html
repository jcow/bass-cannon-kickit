<html>

<head>

<script>

	var cannon_button = {
		x:0,
		y:0,
		radius: 40,

		initialize:function(){
			this.x = game.width-this.radius-10
			this.y = game.height-this.radius-10
		},

		draw:function(){
			game.ctx.beginPath();
			game.ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI, false);
			game.ctx.fillStyle = 'green';
			game.ctx.fill();
			game.ctx.lineWidth = 5;
			game.ctx.strokeStyle = '#003300';
			game.ctx.stroke();

			game.ctx.fillStyle = "#FFFFFF"
			game.ctx.font = "14px bold Arial";
			game.ctx.fillText(" PUMP ", game.width-73, game.height-45)
		}
	}

	var landing_target = {
		x:0,
		y:0,
		width:0,
		height:0,

		initialize:function(){
			this.height = 10
			this.width = game.width
			this.x = 0
			this.y = game.height-this.height
		},

		draw:function(){
			game.ctx.fillStyle = "#CCFF33"
			game.ctx.fillRect(this.x + game.offset_x, this.y+game.offset_y, this.width, this.height)
		},

		will_collide:function(y){
			return (this.y+game.offset_y <= y)
		}
	}

	var wind = {
		speed:0,
		set_random_speed:function(){
			this.speed = 1
		},

		draw:function(){

		}
	}

	var game = {	
		width: 600,
		height: 600,
		canvas:null,
		ctx:null,
		timer:null,
		offset_x:0,
		offset_y:0,
		wind_speed:0,
		state:"initial_container",
		
		times_button_has_been_clicked: 20,

		setup:function(){
			image_loader.load(this.loaded);
			this.canvas = document.getElementById('game_canvas');
			this.canvas.width = this.width;
			this.canvas.height = this.height;
			this.ctx = this.canvas.getContext('2d');
			background.initialize();
			cannon_button.initialize();
			landing_target.initialize();
			clouds.initialize();
			this.when_canvas_is_clicked();
		},
		
		loaded:function(){
			this.timer = setInterval(function(){game.run()}, 16 );	
		},
		
		run:function(){
			this.update();
			this.draw();
		},

		update:function(){
			if(this.state == "game"){
				hamster.update()
				clouds.update()

				if(hamster.is_going_up() && hamster.speed <= 0){
					hamster.set_is_going_down()
				}


				//if(hamster.is_parachuting() && landing_target.will_collide(this.offset_y+hamster.speed)){
				//	hamster.set_has_landed()
				//}
				else if(hamster.is_going_up() || hamster.is_going_down() || hamster.is_parachuting()){
					this.offset_y = this.offset_y + hamster.speed
					this.offset_x = this.offset_x + this.wind_speed
				}

				if(hamster.is_going_down() && this.offset_y <= 4000){
					hamster.set_is_parachuting()
					this.wind_speed = -1
				}
			}
		},

		draw:function(){
			if(this.state == "game"){
				this.ctx.clearRect (0, 0, this.canvas.width, this.canvas.height);
				background.draw();
				cannon_button.draw();
				hamster.draw();
				cannon.draw();
				this._draw_hamster_height();
				countdown.draw();
				clouds.draw()
				if(hamster.is_parachuting() || hamster.has_landed()){
					landing_target.draw();
				}
			}
			else{
				initial_container.draw()
			}
		},
		
		_draw_hamster_height:function(){
			this.ctx.font="30px Arial";
			var fillcolors = {}
			fillcolors.r = 255 - parseInt(background.sky_color.r)
			fillcolors.g = 255 - parseInt(background.sky_color.g)
			fillcolors.b = 255 - parseInt(background.sky_color.b)
			this.ctx.fillStyle = "rgb("+fillcolors.r+","+fillcolors.g+","+fillcolors.b+")"
			this.ctx.fillText("Height: "+hamster.get_air_height()+"ft",10,40);
		},
		
		when_canvas_is_clicked:function(){
			
			this.canvas.onclick = function(e){
				if(game.state == "game"){
					var x;
					var y;
					if (e.pageX || e.pageY) { 
					  x = e.pageX;
					  y = e.pageY;
					}
					else { 
					  x = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft; 
					  y = e.clientY + document.body.scrollTop + document.documentElement.scrollTop; 
					} 
					x -= game.canvas.offsetLeft;
					y -= game.canvas.offsetTop;


					var dist_to_button = Math.sqrt(Math.pow(cannon_button.x - x, 2) + Math.pow(cannon_button.y - y, 2))

					if(dist_to_button <= cannon_button.radius && hamster.is_in_cannon()){
						game.times_button_has_been_clicked++;
					}
				}
				else{
					game.state = "game";
					countdown.start();
				}
			}
		}

	}
	
	var image_loader = {
		done_loading:function(){},
		loaded_count:0,
		loaded_images:{},
		images_to_load:[
			"cannon",
			"hamtaro",
			"bg",
			"cloud",
			"cloud_bg",
			"parachute",
			"cloud"
		],
		
		get_image:function(name){
			return this.loaded_images[name];
		},
		
		load:function(callback){
			this.done_loading = callback;
		
			for(var i in this.images_to_load){
				this.loaded_images[this.images_to_load[i]] = new Image();
				this.loaded_images[this.images_to_load[i]].onLoad = this.when_loaded();
				this.loaded_images[this.images_to_load[i]].src = this.images_to_load[i]+'.png';
				
			}
		},
		
		when_loaded:function(){
			this.loaded_count++;
			if(this.loaded_count == this.images_to_load.length){
				this.done_loading();
			}
		}
	}
	
	var clouds = {
		cloud_counter:0,
		cloud_holder:[],
		width:75,
		height:33,
	
		initialize:function(){
			just do the cloud thing where you make clouds that fall through the current view
		},
	
		update:function(){
			
		},
		
		draw:function(){
			
		}
	}

	
	var hamster = {
		state:"in_cannon",
		width: 50,
		height: 57,
		parachute_height:158,
		parachute_width:198,
		speed:0,

		update:function(){
			if(this.is_going_up() || this.is_going_down()){
				this.speed--
			}
		},

		draw:function(){
			game.ctx.drawImage(image_loader.get_image("hamtaro"), (game.width/2) - (this.width/2), game.height-cannon.cannon_height-this.height+18, this.width, this.height);
			if(this.has_landed() || this.is_parachuting()){
				game.ctx.drawImage(image_loader.get_image("parachute"), (game.width/2) - (this.parachute_width/2), game.height-cannon.cannon_height-this.height+30-this.parachute_height, this.parachute_width, this.parachute_height);
			}
		},
		
		get_air_height:function(){
			return game.offset_y
		},

		is_in_cannon:function(){
			return (this.state === "in_cannon")?true:false;
		},

		is_going_up:function(){
			return (this.state === "going_up")?true:false;
		},

		is_going_down:function(){
			return (this.state === "going_down")?true:false;
		},

		is_parachuting:function(){
			return (this.state === "parachuting")?true:false;
		},
		
		has_landed:function(){
			return (this.state === "has_landed")?true:false;
		},

		set_is_going_up:function(){
			this.state = "going_up";
		},

		set_is_parachuting:function(){
			this.state = "parachuting"
			this.speed = -20
		},

		set_is_going_down:function(){
			this.state = "going_down"
			this.speed = 0
		},

		set_has_landed:function(){
			this.state = "landed"
			this.speed = 0
		},

		set_initial_speed:function(){
			this.speed = game.times_button_has_been_clicked * 10
		}
	}	
	
	var cannon = {
		force:0,
		cannon_height:150,
		cannon_width:50,
		
		draw:function(){
			game.ctx.drawImage(image_loader.get_image("cannon"), (game.width/2)-(this.cannon_width/2) + game.offset_x, game.offset_y+game.height-this.cannon_height, this.cannon_width, this.cannon_height);
		}
	}
	
	var background = {
		counter:0,
		last_hamster_height:0,
		sky_color:{
			r:209,g:241,b:255
		},
		
		initialize:function(){},
		
		reset_cloud:function(cloud_index){
			this.clouds[cloud_index] = this.make_cloud()
		},
		
		make_cloud:function(x,y){
			if(typeof x === 'undefined' && typeof y === 'undefined'){
				x = (Math.floor(Math.random() * game.width-100) -100)
				y = -image_loader.get_image("cloud").height - game.offset_y
			}
			
			return {
				offset_x:x,
				offset_y:y
			}
		},
		
		draw:function(){
			
			game.ctx.fillStyle = "rgb("+parseInt(this.sky_color.r)+","+parseInt(this.sky_color.g)+","+parseInt(this.sky_color.b)+")"
			game.ctx.fillRect(0, 0, game.canvas.width, game.canvas.height);
			
			var bg_image = image_loader.get_image("bg")
			game.ctx.drawImage(bg_image, 0, parseInt(hamster.get_air_height()/10) + game.height - bg_image.height, bg_image.width, bg_image.height);
			
			if(hamster.is_going_up() == hamster.get_air_height() > 100000 && hamster.get_air_height() - this.last_hamster_height > 235){
				this.last_hamster_height = hamster.get_air_height()
				this.sky_color.r = this.sky_color.r - 0.5
				this.sky_color.g = this.sky_color.g - 0.5
				this.sky_color.b = this.sky_color.b - 0.5
			}
			
			
			this.counter++
		}
	}
	
	var countdown = {
		timer:null,
		cannon_pump_time:2,
		
		start:function(){
			if(this.timer === null){
				this.timer = setInterval(function(){countdown.update()}, 1000);	
			}
		},
		
		update:function(){
			if(this.cannon_pump_time > 0){
				this.cannon_pump_time = this.cannon_pump_time - 1
			}
			
			if(this.cannon_pump_time <= 0 && hamster.is_in_cannon()){
				hamster.set_is_going_up()
				hamster.set_initial_speed()
			}
		},
		
		draw:function(){
			if(this.cannon_pump_time > 0){
				game.ctx.font = "40px Arial";
				game.ctx.fillStyle = "#000"
				game.ctx.fillText(this.cannon_pump_time, (game.width/2)-15, 200);
			}
		}
	}
	
	var initial_container = {
		offset_x:20,
		offset_y:40,
		font_size:18,
		line_spacing:5,
		text:[
			"In the near future, hamsters have discovered the power of flight.",
			"Your mission is to assist the flight program with testing.",
			"",
			"To help them with their mission, you will be powering the airpump for",
			"the cannon (yes it's air powered - the program is still in it's infancy).",
			"",
			"INSTRUCTIONS",
			"You will click a button in the bottom-right hand corner which pumps air",
			"into the cannon. The only problem is that you will only have "+countdown.cannon_pump_time,
			"seconds to pump air into the cannon due to the limited technology.",
			"",
			"Whenever you are ready, CLICK THE SCREEN TO BEGIN."
			
		],
		draw:function(){
			game.ctx.fillStyle = "#000"
			game.ctx.fillRect(0, 0, game.canvas.width, game.canvas.height);
			
			game.ctx.font = this.font_size + "px Arial";
			game.ctx.fillStyle = "#FFF"
			
			var counter = this.offset_y
			for(var i in this.text){
				game.ctx.fillText(this.text[i], this.offset_x, counter);
				counter += this.font_size + this.line_spacing
			}
			
			
		}
		
	}
	
	

	window.onload = function(){
		game.setup();
	}

</script>


<style>#canvas_container{margin: 40px auto 40px auto; width: 600px; height: 600px; border: 1px solid #333;}</style>
</head>

<body>
	<div id="canvas_container">
		<canvas id="game_canvas"></canvas>
	</div>
</body>

</html>
